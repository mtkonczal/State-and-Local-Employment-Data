mean(c$rate)
sum(c$rate)
c$rate
mean(c$rate)
c$rate
sum(c$New_vehicles, c$Used_cars_and_trucks, c$Energy) / sum(c$All_items)
sum(c$New_vehicles) + sum(c$Used_cars_and_trucks) + sum(c$Energy) / sum(c$All_items)
(sum(c$New_vehicles) + sum(c$Used_cars_and_trucks) + sum(c$Energy)) / sum(c$All_items)
sum(c$Used_cars_and_trucks)
sum(c$Used_cars_and_trucks)/sum(c$All_items)
# TRY COMPUSTAT
library(tidyverse)
library(janitor)
library(DescTools)
cs_data <- read_csv(file = "compustat_data.csv")
cs <- cs_data %>%
filter(fyear == 2021) %>%
filter(at > 1) %>%
filter(sale > 0) %>%
filter(exchg == 11) %>%
mutate(TobinQ = ( (csho * prcc_f) + lt + pstk ) / at) %>%
filter(TobinQ != "NA") %>%
mutate(profits = ni/sale) %>%
mutate(lerner = (oibdp - dp) / sale) %>%
mutate(TobinQW = Winsorize(TobinQ, 0, 6.47)) %>%
mutate(profitsW = Winsorize(profits, -.25, .40)) %>%
mutate(lernerW = Winsorize(lerner, 0, 1))
quantile(cs$TobinQ, c(0.05,0.95))
quantile(cs$profits, c(0.05,0.95))
summary(cs$profits)
plot(cs$TobinQW, cs$profitsW)
plot(cs$lernerW, cs$profitsW)
plot(cs$TobinQW, cs$profitsW)
a <- lm(cs$profitsW ~ cs$TobinQW)
summary(a)
View(cs)
cs2 <- cs_data %>%
mutate(profits = ni/sale) %>%
group_by(tic) %>%
mutate(profits_change = profits/lag(profits))
View(cs2)
cs2 <- cs_data %>%
mutate(profits = ni/sale) %>%
group_by(tic) %>%
mutate(profits_change = profits/lag(profits)) %>%
filter(fyear == 2021)
plot(cs2$profits_change)
summary(cs2$profits_change)
quantile(cs2$profits_change, c(0.05,0.95))
quantile(cs2$profits_change, c(0.05,0.95), na.rm = TRUE)
cs2 <- cs_data %>%
mutate(profits = ni/sale) %>%
group_by(tic) %>%
mutate(profits_change = profits/lag(profits)) %>%
filter(fyear == 2021) %>%
mutate(profits_changeW = Winsorize(profits_change, -2.5, 5.3))
plot(cs2$profits_change)
plot(cs2$profits_change)
plot(cs2$profits_changeW)
mean(plot(cs2$profits_changeW))
summary(cs2$profits_changeW)
cs2 <- cs_data %>%
mutate(profits = ni/sale) %>%
group_by(tic) %>%
mutate(profits_change = profits/lag(profits,2)) %>%
filter(fyear == 2021) %>%
mutate(profits_changeW = Winsorize(profits_change, -2.5, 5.3))
summary(cs2$profits_changeW)
View(cs2)
cs2 <- cs_data %>%
mutate(TobinQ = ( (csho * prcc_f) + lt + pstk ) / at) %>%
mutate(TobinQW = Winsorize(TobinQ, 0, 6.47)) %>%
mutate(profits = ni/sale) %>%
group_by(tic) %>%
mutate(profits_change = profits/lag(profits,2)) %>%
filter(fyear == 2021) %>%
mutate(profits_changeW = Winsorize(profits_change, -2.5, 5.3))
summary(cs2$profits_changeW)
plot(cs2$profits_changeW, cs2$TobinQW)
plot(cs2$TobinQW, cs2$profits_changeW)
cs2 <- cs_data %>%
mutate(TobinQ = ( (csho * prcc_f) + lt + pstk ) / at) %>%
mutate(profits = ni/sale) %>%
group_by(tic) %>%
mutate(profits_change = profits/lag(profits,2)) %>%
filter(fyear == 2021) %>%
filter(TobinQ > 0) %>%
filter(TobinQ < 6) %>%
filter(profits_change > 2.5) %>%
filter(profits_change < 5)
summary(cs2$profits_change)
plot(cs2$TobinQ, cs2$profits_change)
cs2 <- cs_data %>%
mutate(TobinQ = ( (csho * prcc_f) + lt + pstk ) / at) %>%
mutate(profits = ni/sale) %>%
group_by(tic) %>%
mutate(profits_change = profits/lag(profits,2)) %>%
filter(fyear == 2021) %>%
filter(TobinQ > 0) %>%
filter(TobinQ < 6) %>%
filter(profits_change > -2.5) %>%
filter(profits_change < 5)
plot(cs2$TobinQ, cs2$profits_change)
a <- lm(cs2$profits_change ~ cs2$TobinQ)
lines(a)
a
line(a)
abline(a)
summary(a)
plot(cs2$sale, cs2$profits_change)
a <- lm(cs2$profits_change ~ cs2$sale)
abline(a)
summary(a)
quantile(cs$sale, c(0.05,0.95))
cs2 <- cs_data %>%
mutate(TobinQ = ( (csho * prcc_f) + lt + pstk ) / at) %>%
mutate(profits = ni/sale) %>%
group_by(tic) %>%
mutate(profits_change = profits/lag(profits,2)) %>%
filter(fyear == 2021) %>%
filter(TobinQ > 0) %>%
filter(TobinQ < 6) %>%
filter(profits_change > -2.5) %>%
filter(profits_change < 5) %>%
filter(sale > 220) %>%
filter(sale < 51000)
plot(cs2$TobinQ, cs2$profits_change)
a <- lm(cs2$profits_change ~ cs2$TobinQ)
abline(a)
summary(a)
plot(cs2$sale, cs2$profits_change)
a <- lm(cs2$profits_change ~ cs2$sale)
abline(a)
summary(a)
setwd("/Users/mkonczal/Documents/GitHub/State-and-Local-Employment-Data/")
library(janitor)
library(tidyverse)
library(ggtext)
############### READ IN AND CLEAN UP STATE AND LOCAL EMPLOYMENT DATA ########################################
# Read in files
state_industry_codes <- read_delim(file = "https://download.bls.gov/pub/time.series/sm/sm.industry")
state_data_type_codes <- read_delim(file = "https://download.bls.gov/pub/time.series/sm/sm.data_type")
supersector_codes <- read_delim(file = "https://download.bls.gov/pub/time.series/sm/sm.supersector")
state_codes <- read_delim(file = "https://download.bls.gov/pub/time.series/sm/sm.state")
area_codes <- read_delim(file = "https://download.bls.gov/pub/time.series/sm/sm.area")
sae_series_code <- read_delim(file = "https://download.bls.gov/pub/time.series/sm/sm.series")
sae_series_code <- sae_series_code %>%
clean_names()
sae_series_code$series_id <- str_trim(sae_series_code$series_id)
sae <- read_delim(file = "https://download.bls.gov/pub/time.series/sm/sm.data.0.Current")
sae <- sae %>%
clean_names()
sae$value <- as.numeric(sae$value)
sae$series_id <- str_trim(sae$series_id)
sae <- inner_join(sae, sae_series_code, by = c("series_id"))
sae <- inner_join(sae, state_codes, by = c("state_code"))
sae <- inner_join(sae, area_codes, by = c("area_code"))
sae <- inner_join(sae, supersector_codes, by = c("supersector_code"))
sae <- inner_join(sae, state_industry_codes, by = c("industry_code"))
sae <- inner_join(sae, state_data_type_codes, by = c("data_type_code"))
# Remove some columns we won't use, but may in the future.
sae <- select(sae, -c("footnote_codes.x", "footnote_codes.y", "benchmark_year", "begin_year", "begin_period", "end_year", "end_period"))
# NEXT TK - INTRODUCE MULTIPLE MONTHS AVERAGE FOR UNADJUSTED
# sae_change - finds the total and percent change of an employment number in the sae database we created.
# x - sae database created in Part 1.
# y - an industry code within the database, sent as character.
# s - "S" for seasonally adjusted, "U" for unadjusted. Important for sub-categories.
# year_start, year_end - number with the year.
# month_term - month, in format "M01" for January.
sae_change <- function(x, y, s, year_start, year_end, month_term){
sae_change_gov <- x %>%
filter(industry_code == y) %>%
filter(data_type_code == "01") %>%
filter(seasonal == s) %>%
filter(year == year_start | year == year_end) %>%
filter(area_code == "00000") %>%
filter(period == month_term) %>%
# Get total change and percent change
group_by(state_name) %>%
arrange(year) %>%
mutate(gov_job_loss = value-lag(value)) %>%
mutate(gov_job_loss_percent = gov_job_loss/lag(value)) %>%
filter(gov_job_loss != "NA") %>%
select(state_name, gov_job_loss, gov_job_loss_percent)
return(sae_change_gov)
}
by_total <- sae_change(sae, "90000000", "S", 2019, 2021, "M12")
by_total_GR <- sae_change(sae, "90000000", "S", 2008, 2011, "M12")
by_total_2019 <- sae_change(sae, "90000000", "S", 2019, 2020, "M12")
by_total_2020 <- sae_change(sae, "90000000", "S", 2020, 2021, "M12")
by_total$GR <- by_total_GR$gov_job_loss_percent
by_total$y2019 <- by_total_2019$gov_job_loss_percent
by_total$y2020 <- by_total_2020$gov_job_loss_percent
by_total
by_federal <- sae_change(sae, "90910000", "S", 2019, 2021, "M12")
by_state <- sae_change(sae, "90920000", "S", 2019, 2021, "M12")
by_local <- sae_change(sae, "90930000", "S", 2019, 2021, "M12")
hist(by_total$gov_job_loss_percent)
sum(by_total$gov_job_loss)
sum(by_federal$gov_job_loss)
sum(by_state$gov_job_loss)
sum(by_local$gov_job_loss)
by_total_U <- sae_change(sae, "90000000", "U", 2019, 2021, "M12")
by_federal_U <- sae_change(sae, "90910000", "U", 2019, 2021, "M12")
by_state_U <- sae_change(sae, "90920000", "U", 2019, 2021, "M12")
by_local_U <- sae_change(sae, "90930000", "U", 2019, 2021, "M12")
by_state_UE <- sae_change(sae, "90921611", "U", 2019, 2021, "M12")
by_local_UE <- sae_change(sae, "90931611", "U", 2019, 2021, "M12")
by_state_UNE <- sae_change(sae, "90922000", "U", 2019, 2021, "M12")
by_local_UNE <- sae_change(sae, "90932000", "U", 2019, 2021, "M12")
View(by_state)
by_local_UNE <- sae_change(sae, "90932000", "U", 2019, 2021, "M12")
by_local_UNE
by_total <- by_total %>%
rowwise() %>%
arrange(gov_job_loss_percent) %>%
mutate(state_name=factor(state_name, state_name))
by_total <- by_total %>%
filter(state_name != "Virgin Islands") %>%
filter(state_name != "District of Columbia") %>%
filter(state_name != "Puerto Rico")
# FIRST GRAPHIC - LOSSES ACROSS STATES
ggplot(by_total, aes(x=state_name, y=gov_job_loss_percent)) +
geom_segment( aes(x=state_name, xend=state_name, y=0, yend=gov_job_loss_percent), color="grey") +
geom_point( color="dark red", size=3) +
theme_light() +
coord_flip() +
xlab("") +
ylab("Percent") +
ggtitle("Change in State and Local Government Employment, Dec 2019 to Dec 2021") +
theme(
panel.grid.major.y = element_blank(),
plot.title.position = "plot",
panel.border = element_blank(),
axis.ticks.y = element_blank()
)
ggsave("state_local_loss.png")
# SECOND GRAPHIC - LOSSES ACROSS YEARS
by_total_years <- by_total %>%
arrange(y2019)
ggplot(by_total_years) +
geom_segment( aes(x=state_name, xend=state_name, y=gov_job_loss_percent, yend=y2020), color="grey") +
geom_point( aes(x=state_name, y=gov_job_loss_percent), color="dark red", size=3 ) +
geom_point( aes(x=state_name, y=y2020), color="#228b22", size=3 ) +
coord_flip()+
theme_light() +
theme(panel.grid.major.x = element_blank(),
plot.title = element_markdown()) +
ggtitle("Change in State and Local Government Employment, <span style = 'color:#8b0000;'>2019 to 2020</span> and <span style = 'color:#228b22;'>2020 to 2021</span>, all December") +
theme(
panel.grid.major.y = element_blank(),
panel.border = element_blank(),
plot.title.position = "plot",
axis.ticks.y = element_blank()
) +
xlab("") +
ylab("Percent") +
geom_hline(yintercept=0, linetype="solid", color = "black", alpha=0.5)
ggsave("losses_by_years.png")
ggplot(by_total) +
geom_segment( aes(x=state_name, xend=state_name, y=gov_job_loss_percent, yend=GR), color="grey") +
geom_point( aes(x=state_name, y=gov_job_loss_percent), color="dark red", size=3 ) +
geom_point( aes(x=state_name, y=GR), color="#228b22", size=3 ) +
coord_flip()+
theme_light() +
theme(panel.grid.major.x = element_blank(),
plot.title = element_markdown()) +
ggtitle("Change in State and Local Government Employment, <span style = 'color:#8b0000;'>2019 to 2021</span> and <span style = 'color:#228b22;'>2008 to 2011</span>, all December") +
theme(
panel.grid.major.y = element_blank(),
panel.border = element_blank(),
plot.title.position = "plot",
axis.ticks.y = element_blank()
) +
xlab("") +
ylab("Percent") +
geom_hline(yintercept=0, linetype="solid", color = "black", alpha=0.5)
ggsave("losses_vs_Great_Recession.png")
library(janitor)
library(tidyverse)
#let's try this with employment to start
e <- read_delim(file = "https://download.bls.gov/pub/time.series/ce/ce.data.00a.TotalNonfarm.Employment")
d <- read_delim(file = "https://download.bls.gov/pub/time.series/ce/ce.series")
e <- e %>%
clean_names()
e$series_id <- str_trim(e$series_id)
e$value <- as.numeric(e$value)
d <- d %>%
clean_names()
d$series_id <- str_trim(d$series_id)
fd <- inner_join(d, e, by = c("series_id"))
fde <- fd %>%
filter(year > 2018)
w_e <- fde %>%
filter(series_id == 'CES0000000001')
plot(w_e$value, type="l")
library(janitor)
library(tidyverse)
#let's try this with employment to start
e <- read_delim(file = "https://download.bls.gov/pub/time.series/ce/ce.data.00a.TotalNonfarm.Employment")
d <- read_delim(file = "https://download.bls.gov/pub/time.series/ce/ce.series")
e <- e %>%
clean_names()
e$series_id <- str_trim(e$series_id)
e$value <- as.numeric(e$value)
d <- d %>%
clean_names()
d$series_id <- str_trim(d$series_id)
fd <- inner_join(d, e, by = c("series_id"))
fde <- fd %>%
filter(year > 2018)
w_e <- fde %>%
filter(series_id == 'CES0000000001')
plot(w_e$value, type="l")
View(e)
View(d)
View(fd)
View(fde)
ces_data <- read_delim(file = "https://download.bls.gov/pub/time.series/ce/ce.data.0.AllCESSeries")
ces_data
d <- read_delim(file = "https://download.bls.gov/pub/time.series/ce/ce.series")
d
ces_series <- read_delim(file = "https://download.bls.gov/pub/time.series/ce/ce.series")
ces_data
ces_data
ces_data <- ces_data %>%
clean_names()
ces_data
ces_data <- read_delim(file = "https://download.bls.gov/pub/time.series/ce/ce.data.0.AllCESSeries")
ces_series <- read_delim(file = "https://download.bls.gov/pub/time.series/ce/ce.series")
ces_data <- ces_data %>%
clean_names()
ces_data$series_id <- str_trim(ces_data$series_id)
ces_data$value <- as.numeric(ces_data$value)
ces_series <- ces_series %>%
clean_names()
ces_series$series_id <- str_trim(ces_series$series_id)
ces_data <- inner_join(ces_data, ces_series, by = c("series_id"))
ces_data
ces <- ces_data %>%
filter(year > 2018)
ces <- ces_data %>%
filter(year > 2018) %>%
filter(series_id == 'CES0000000001')
plot(ces$value, type="l")
ces <- ces_data %>%
filter(year > 2017) %>%
filter(series_id == 'CES0000000001')
plot(ces$value, type="l")
ces <- ces_data %>%
filter(year > 2017)
unqiue(ces$series_title)
unique(ces$series_title)
ces <- ces_data %>%
filter(year > 2017) %>%
filter(series_id == 'CES0000000001')
View(ces)
categories <- c("CES0500000001",
"CES0600000001",
"CES1000000001",
"CES2000000001",
"CES3000000001",
"CES3100000001",
"CES3200000001",
"CES0800000001",
"CES4000000001",
"CES4142000001",
"CES4200000001",
"CES4300000001",
"CES5000000001",
"CES5500000001",
"CES6000000001",
"CES6500000001",
"CES7000000001",
"CES8000000001",
"CES9000000001")
categories <- c("CES0500000001",
"CES0600000001",
"CES1000000001",
"CES2000000001",
"CES3000000001",
"CES3100000001",
"CES3200000001",
"CES0800000001",
"CES4000000001",
"CES4142000001",
"CES4200000001",
"CES4300000001",
"CES5000000001",
"CES5500000001",
"CES6000000001",
"CES6500000001",
"CES7000000001",
"CES8000000001",
"CES9000000001")
test <- ces_data %>%
filter(series_id in categories)
test <- ces_data %>%
filter(series_id %in% categories)
View(test)
test <- ces_data %>%
filter(series_id %in% categories) %>%
filter(year > 2018)
test <- ces_data %>%
filter(series_id %in% categories) %>%
filter(year > 2018) %>%
group_by(series_id) %>%
mutate(percent_change = (value-lag(value))/lag(value))
View(test)
ces_data <- select(ces_data, -c("footnote_codes.x", "footnote_codes.y", "begin_year", "begin_period", "end_year", "end_period"))
ces_data
categories <- c("CES0500000001",
"CES0600000001",
"CES1000000001",
"CES2000000001",
"CES3000000001",
"CES3100000001",
"CES3200000001",
"CES0800000001",
"CES4000000001",
"CES4142000001",
"CES4200000001",
"CES4300000001",
"CES5000000001",
"CES5500000001",
"CES6000000001",
"CES6500000001",
"CES7000000001",
"CES8000000001",
"CES9000000001")
test <- ces_data %>%
filter(series_id %in% categories) %>%
filter(year > 2018) %>%
group_by(series_id) %>%
mutate(percent_change = (value-lag(value))/lag(value))
test <- ces_data %>%
filter(series_id %in% categories) %>%
filter(year > 2019) %>%
filter(period == "M01") %>%
group_by(series_id) %>%
mutate(percent_change = (value-lag(value))/lag(value))
test <- ces_data %>%
filter(series_id %in% categories) %>%
filter(year > 2019) %>%
filter(period == "M01") %>%
group_by(series_id) %>%
mutate(percent_change = (value-lag(value, 2))/lag(value, 2))
test <- ces_data %>%
filter(series_id %in% categories) %>%
filter(year > 2019) %>%
filter(period == "M01") %>%
group_by(series_id) %>%
mutate(percent_change = (value-lag(value, 2))/lag(value, 2)) %>%
filter(year == 2021)
View(test)
test <- ces_data %>%
filter(series_id %in% categories) %>%
filter(year > 2019) %>%
filter(period == "M01") %>%
group_by(series_id) %>%
mutate(percent_change = (value-lag(value, 2))/lag(value, 2))
View(test)
test <- ces_data %>%
filter(series_id %in% categories) %>%
filter(year > 2019) %>%
filter(period == "M01") %>%
group_by(series_id) %>%
mutate(percent_change = (value-lag(value, 2))/lag(value, 2)) %>%
filter(year == 2022)
View(test)
test <- ces_data %>%
filter(series_id %in% categories) %>%
filter(year > 2019) %>%
filter(period == "M01") %>%
group_by(series_id) %>%
mutate(percent_change = 100*(value-lag(value, 2))/lag(value, 2)) %>%
filter(year == 2022)
View(test)
test <- ces_data %>%
filter(series_id %in% categories) %>%
filter(year > 2019) %>%
filter(period == "M01") %>%
group_by(series_id) %>%
mutate(percent_change = 100*(value-lag(value, 2))/lag(value, 2)) %>%
filter(year == 2022)
View(test)
test <- ces_data %>%
filter(series_id %in% categories) %>%
filter(year > 2019) %>%
filter(period == "M01") %>%
group_by(series_id) %>%
mutate(percent_change = 100*(value-lag(value, 2))/lag(value, 2)) %>%
filter(year == 2022) %>%
mutate(missing_workers = precent_change*value/100)
test <- ces_data %>%
filter(series_id %in% categories) %>%
filter(year > 2019) %>%
filter(period == "M01") %>%
group_by(series_id) %>%
mutate(percent_change = 100*(value-lag(value, 2))/lag(value, 2)) %>%
filter(year == 2022) %>%
mutate(missing_workers = percent_change*value/100)
View(test)
test <- ces_data %>%
filter(series_id %in% categories) %>%
filter(year > 2019) %>%
filter(period == "M01") %>%
group_by(series_id) %>%
mutate(percent_change = 100*(value-lag(value, 2))/lag(value, 2)) %>%
filter(year == 2022) %>%
mutate(missing_workers = percent_change*value/100)
test
